{% extends 'base.html' %} 
{% load static %}
{% load discount_tags %}

{% block head %}
<title>{{ store.name }}</title>
{% endblock %} 

{% block body %}

<!-- Store info -->
<header class="container my-4">
    <a href="{% url 'home' %}">üè† Volver al Callej√≥n Diagon</a>
    <h1>{{ store.name }}</h1>
    <p>{{ store.description }}</p>
    {% if store.image_url %}
    <img src="{{ store.image_url }}" alt="Imagen de {{ store.name }}" class="img-fluid" style="max-width: 300px"/>
    {% endif %}

    {% if store.store_type == 'wand' %}
    <p>Usa el emoji ‚ûñ para representar varitas en actividades del colegio.</p>
    {% elif store.store_type == 'broom' %}
    <p>Usa el emoji üßπ para representar escobas en actividades del colegio.</p>
    {% endif %}
</header>

<!-- Store products -->
<main class="container my-4">
    <h2 class="text-center mb-4">Productos disponibles:</h2>

    <div class="row justify-content-center">
        {% for item in warehouse_items %}
        <div class="col-sm-12 col-md-6 col-lg-4 mb-4">
            <li class="card h-100">
                <div class="card-body d-flex flex-column">
                    <button type="button" class="btn btn-primary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#usersModal"
                            data-product-id="{{ item.product.id }}"
                            data-product-name="{{ item.product.name }}">
                        Ver usuarios
                    </button>

                    <h5 class="card-title">{{ item.product.name }}</h5>
                    <h6 class="card-subtitle mb-2 text-body-secondary">{{ item.product.description }}</h6>
                    
                    <!-- Discount -->
                    {% if discount != 0.0 %}
                    <p class="card-text">Precio original: <s>{{ item.product.price }} galeones</s></p>
                    <p class="card-text">
                        Precio con descuento: {{ item.product.price|dis:discount }} galeones
                    </p>
                    {% else %}
                    <p class="card-text">Precio: {{ item.product.price }} galeones</p>
                    {% endif %}

                    <p class="card-text">Duraci√≥n: {{ item.product.duration_days }} d√≠as</p>

                    {% if item.product.uses %}
                    <p class="card-text">Usos: {{ item.product.uses }}</p>
                    {% endif %} 
                    
                    {% if item.stock %}
                    <p class="card-text">Stock: {{ item.stock }} restantes</p>
                    {% endif %}

                    <p class="card-text mt-auto">
                        Estado: {% if item.available %}
                        <span style="color: green">Disponible</span> <br />
                        {% else %}
                        <span style="color: red">No disponible</span> <br />
                        {% endif %}
                    </p>

                    <!-- Product opions -->
                    <form method="post">
                        {% csrf_token %}
                        <input
                            type="hidden"
                            name="product_id"
                            value="{{ item.product.id }}"
                        />

                        <div class="d-flex gap-3">
                            <!-- Purchase -->
                            <button
                                type="button"
                                class="btn btn-primary w-100"
                                data-title="Confirmaci√≥n de compra"
                                data-message="¬øDeseas comprar {{ item.product.name }} (Esta acci√≥n es irreversible)?"
                                onclick="showConfirm(this)"
                            >
                                Comprar
                            </button>

                            <!-- Gift -->
                            <button type="button" class="btn btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#giftModal"
                                data-url="{% url 'gift' item.product.id %}">
                                Regalar
                            </button>
                        </div>
                    </form>
                </div>
            </li>
        </div>
        {% empty %} 
        <li>No hay productos disponibles en esta tienda.</li>
        {% endfor %}
    </div>
</main>

{% endblock %}

<!-- Modals templates -->
{% block modals %}
{{ block.super }}
{% if not working_hours %}
{% include "components/modal/working_hours_modal.html" %}
{% endif %}
{% include "modal/product_owners_modal.html" %}
{% include "modal/gift_modal.html" %}
{% endblock %}